{% extends 'admin_base.html' %}
{% load static %}
{% block content %}

<div class="container">
    <div class="page-inner">
    <div class="page-inner d-flex justify-content-between align-items-center">
        <h3>Level {{ level.number }} - {{ level.category.name }}</h3>
        <!-- Add Round Button -->
        <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addRoundModal">
            + Add Round
        </button>
    </div>
    <p><strong>Description:</strong> {{ level.description|default:"N/A" }}</p>
    <hr>

    {% if rounds %}
        {% for round in rounds %}
            <div class="card mb-3 shadow-sm">
           <div class="card-header d-flex justify-content-between align-items-center">
    <h5 class="mb-0">Round {{ round.number }} ({{ round.mode|title }})</h5>
</div>
<!-- Modal -->
<div class="modal fade" id="lastDateModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content rounded-3 shadow">
      <div class="modal-header">
        <h5 class="modal-title">Set Registration Dates</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="lastDateForm">
            {% csrf_token %}
            <input type="hidden" name="round_id" id="lastDateRoundId">

            <div class="mb-3">
                <label class="form-label">Registration Start Date</label>
                <input type="date" name="registration_start_date" id="startDateInput" class="form-control" required>
            </div>

            <div class="mb-3">
                <label class="form-label">Registration End Date</label>
                <input type="date" name="registration_end_date" id="endDateInput" class="form-control" required>
            </div>

           
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="submit" class="btn btn-success">Save</button>
      </div>
        </form>
    </div>
  </div>
</div>


                <div class="card-body">
                    <p>{{ round.description|default:"No description" }}</p>

                    {% if round.schedules.all %}
                        <table class="table table-bordered table-sm">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Time</th>
                                    <th>Total Seats</th>
                                    <th>Booked</th>
                                    <th>Available</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for schedule in round.schedules.all %}
                                <tr>
                                    <td>{{ schedule.date }}</td>
                                    <td>{{ schedule.start_time }} - {{ schedule.end_time }}</td>
                                    <td>{{ schedule.total_seats }}</td>
                                    <td>{{ schedule.booked_seats }}</td>
                                    <td>{{ schedule.available_seats }}</td>
                                    <td>
                                        <button class="btn btn-warning btn-sm schedule-btn"
                                                data-bs-toggle="modal"
                                                data-bs-target="#scheduleModal"
                                                data-round="{{ round.id }}"
                                                data-schedule-id="{{ schedule.id }}"
                                                data-date="{{ schedule.date|date:'Y-m-d' }}"
                                                data-start="{{ schedule.start_time|time:'H:i' }}"
                                                data-end="{{ schedule.end_time|time:'H:i' }}"
                                                data-total="{{ schedule.total_seats }}">
                                            Reschedule
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    {% else %}
                        <button class="btn btn-success btn-sm schedule-btn"
                                data-bs-toggle="modal"
                                data-bs-target="#scheduleModal"
                                data-round="{{ round.id }}">
                            + Add Schedule
                        </button>
                    {% endif %}
                </div>
            </div>
        {% endfor %}
    {% else %}
        <p class="text-muted">No rounds created for this level yet.</p>
    {% endif %}
</div>

<!-- ✅ Schedule Modal -->
<div class="modal fade" id="scheduleModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content rounded-3 shadow">
      <div class="modal-header">
        <h5 class="modal-title">Add / Reschedule Round</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="scheduleForm">
            {% csrf_token %}
            <input type="hidden" name="round_id" id="scheduleRoundId">
            <input type="hidden" name="schedule_id" id="scheduleId">

            <div class="mb-3">
                <label class="form-label">Date</label>
                <input type="date" name="date" id="scheduleDate" class="form-control" required>
            </div>

            <div class="mb-3">
                <label class="form-label">Start Time</label>
                <input type="time" name="start_time" id="scheduleStart" class="form-control" required>
            </div>

            <div class="mb-3">
                <label class="form-label">End Time</label>
                <input type="time" name="end_time" id="scheduleEnd" class="form-control" required>
            </div>

            <div class="mb-3">
                <label class="form-label">Total Seats</label>
                <input type="number" name="total_seats" id="scheduleTotal" class="form-control" required>
            </div>

      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="submit" class="btn btn-success">Save</button>
      </div>
        </form>
    </div>
  </div>
</div>


<!-- ✅ Add Round Modal -->
<div class="modal fade" id="addRoundModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content rounded-3 shadow">
      <div class="modal-header">
        <h5 class="modal-title">Add New Round</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="addRoundForm">
            {% csrf_token %}
            <input type="hidden" name="level_id" value="{{ level.id }}">

            <div class="mb-3">
                <label class="form-label">Round Number</label>
                <input type="number" name="number" class="form-control" required>
            </div>

            <div class="mb-3">
                <label class="form-label">Mode</label>
                <select name="mode" class="form-control" required>
                    <option value="">-- Select Mode --</option>
                    <option value="online">Online</option>
                    <option value="offline">Offline</option>
                </select>
            </div>

            <div class="mb-3">
                <label class="form-label">Description</label>
                <textarea name="description" class="form-control"></textarea>
            </div>

            <div class="mb-3">
                <label class="form-label">Last Registration Date</label>
                <input type="date" name="last_registration_date" class="form-control">
            </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="submit" class="btn btn-success">Save Round</button>
      </div>
        </form>
    </div>
  </div>
</div>

  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.min.js"></script>
<!-- ✅ JS -->
<script>
document.addEventListener("DOMContentLoaded", function () {
    // Fill modal with schedule data
    document.querySelectorAll(".schedule-btn").forEach(btn => {
        btn.addEventListener("click", function(){
            document.getElementById("scheduleRoundId").value = this.dataset.round;
            document.getElementById("scheduleId").value = this.dataset.scheduleId || "";
            document.getElementById("scheduleDate").value = this.dataset.date || "";
            document.getElementById("scheduleStart").value = this.dataset.start || "";
            document.getElementById("scheduleEnd").value = this.dataset.end || "";
            document.getElementById("scheduleTotal").value = this.dataset.total || "";
            
            // Change modal title
            document.querySelector("#scheduleModal .modal-title").innerText =
                this.dataset.scheduleId ? "Reschedule Round" : "Add Schedule";
        });
    });

    // Prevent past date scheduling
    const today = new Date().toISOString().split("T")[0];
    document.getElementById("scheduleDate").setAttribute("min", today);

    // Submit form via fetch
    document.getElementById("scheduleForm").addEventListener("submit", function(e){
        e.preventDefault();
        let formData = new FormData(this);

        fetch("{% url 'add_or_update_schedule' %}", {
            method: "POST",
            body: formData,
            headers: { "X-CSRFToken": "{{ csrf_token }}" }
        })
        .then(res => res.json())
        .then(data => {
            if(data.success){
                Toastify({
                    text: "✅ " + data.message,
                    duration: 3000,
                    gravity: "top",
                    position: "right",
                    backgroundColor: "green",
                }).showToast();
                setTimeout(() => location.reload(), 1000);
            } else {
                Toastify({
                    text: "❌ " + data.error,
                    duration: 3000,
                    gravity: "top",
                    position: "right",
                    backgroundColor: "red",
                }).showToast();
            }
        });
    });
});

// Handle Add Round form
document.getElementById("addRoundForm").addEventListener("submit", function(e){
    e.preventDefault();
    let formData = new FormData(this);

    fetch("{% url 'add_round' %}", {
        method: "POST",
        body: formData,
        headers: { "X-CSRFToken": "{{ csrf_token }}" }
    })
    .then(res => res.json())
    .then(data => {
        if(data.success){
            Toastify({
                text: "✅ " + data.message,
                duration: 3000,
                gravity: "top",
                position: "right",
                backgroundColor: "green",
            }).showToast();
            setTimeout(() => location.reload(), 1000);
        } else {
            Toastify({
                text: "❌ " + data.error,
                duration: 3000,
                gravity: "top",
                position: "right",
                backgroundColor: "red",
            }).showToast();
        }
    });
});

</script>
{% endblock %}
