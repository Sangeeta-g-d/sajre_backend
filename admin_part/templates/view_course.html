{% extends 'admin_base.html' %}
{% block content %}
<div class="container">     
    <div class="page-inner">
        <div class="page-header d-flex justify-content-between align-items-center">
            <h3 class="fw-bold mb-3">Courses Management</h3>
            <a href="/admin_part/add_course/" class="btn btn-secondary btn-sm">+ Add Course</a>
        </div>

        <div class="row">
            {% if courses %}
                {% for course in courses %}
                <div class="col-md-4 col-sm-6 mb-4" id="course-card-{{ course.id }}">
                    <div class="card shadow-sm position-relative h-100">
                        
                        <!-- Action Icons -->
                        <div class="position-absolute top-0 end-0 m-2">
                            <a href="/admin_part/edit_course/{{ course.id }}/" class="btn btn-sm btn-primary me-1">
                                <i class="icon-pencil text-white"></i>
                            </a>
                            <button type="button" 
        class="btn btn-sm btn-danger" 
        onclick="deleteCourse('{{ course.id }}')">
    <i class="icon-trash text-white"></i>
</button>
                        </div>

                        <!-- Image -->
                        {% if course.image %}
                            <img src="{{ course.image.url }}" class="card-img-top" alt="{{ course.name }}" style="height: 200px; object-fit: cover;">
                        {% else %}
                            <div class="bg-light d-flex align-items-center justify-content-center" style="height:200px;">
                                <span class="text-muted">No Image</span>
                            </div>
                        {% endif %}

                        <!-- Body -->
                        <div class="card-body">
                            <h5 class="card-title mb-1">{{ course.name }}</h5>
                            <p class="card-text text-muted">{{ course.subtitle|default:"No subtitle available" }}</p>
                            <small class="text-muted">Created: {{ course.created_at|date:"M j, Y" }}</small>
                        </div>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div class="col-12">
                    <div class="alert alert-info">
                        No courses available. <a href="/admin_part/add_course/">Add a new course</a>.
                    </div>
                </div>
            {% endif %}
        </div>
    </div>  
</div>
<script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
<script>
function deleteCourse(courseId) {
    if (!confirm("Are you sure you want to delete this course?")) return;

    fetch(`/admin_part/delete_course/${courseId}/`, {
        method: "POST",
        headers: {
            "X-Requested-With": "XMLHttpRequest",
            "X-CSRFToken": getCookie("csrftoken")
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            Toastify({
                text: data.message,
                duration: 3000,
                gravity: "top",
                position: "right",
                backgroundColor: "linear-gradient(to right, #ff5f6d, #ffc371)",
            }).showToast();

            // remove deleted card without refresh
            document.querySelector(`#course-card-${courseId}`)?.remove();
        } else {
            Toastify({
                text: "Error: " + data.message,
                duration: 3000,
                gravity: "top",
                position: "right",
                backgroundColor: "red",
            }).showToast();
        }
    })
    .catch(() => {
        Toastify({
            text: "Something went wrong!",
            duration: 3000,
            gravity: "top",
            position: "right",
            backgroundColor: "red",
        }).showToast();
    });
}

// âœ… Helper to get CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== "") {
        const cookies = document.cookie.split(";");
        for (let cookie of cookies) {
            cookie = cookie.trim();
            if (cookie.startsWith(name + "=")) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>

{% endblock %}
