{% extends 'vendor_base.html' %}
{% block content %}
{% load custom_filters %}
<link rel="stylesheet" href="/static/assets/mentor/css/mentor-dashboard.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

<div class="main-content">
    <!-- Updated Header Section with Export Button -->
    <div class="content-header">
        <div class="header-text">
            <h1>Students Registered via Your Referral Link</h1>
            <p style="margin-left: 20px;">Track and manage all students who joined through your mentorship program</p>
        </div>
         <div class="d-flex " style="position: relative;gap: 20px;">
            <button class="export-btn">
                <i class="fas fa-download"></i>Export CSV
            </button>

            <button class="export-btn d-block d-lg-none" id="copyReferralBtn">
                <i class="bi bi-link-45deg me-2"></i>
                <span id="referralCode">{{ request.user.referral_code }}</span>
                <i class="bi bi-clipboard ms-2 copy-icon"></i>
            </button>
        </div> 
    </div>

    <!-- Stats and Actions Container -->
    <div class="stats-actions-container">
        <!-- Stats Cards -->
        <div class="stats-cards">
            <!-- Card 1 -->
            <div class="stat-card">
                <div class="stat-icon blue">
                    <i class="fas fa-users"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-title">Students Registered</div>
                    <div class="stat-value">{{ referred_students_count }}</div>
                    <div class="stat-details">
                        <span class="stat-label">Via your referrals</span>
                    </div>
                </div>

            </div>



            <!-- Card 3 -->
            <div class="stat-card">
                <div class="stat-icon orange">
                    <i class="fas fa-graduation-cap"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-title">Successfully Enrolled</div>
                    <div class="stat-value">{{ enrolled_students_count }}</div>
                    <div class="stat-details">
                        <span class="stat-label">Active in competition</span>
                    </div>
                </div>

            </div>

            <!-- Card 4 -->
             <a href="/vendor/mentor_list/" class="stat-card-link">
            <div class="stat-card">
                <div class="stat-icon red">
                    <i class="fas fa-chalkboard-teacher"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-title">Referred Mentors</div>
                    <div class="stat-value">{{ referred_mentors_count }}</div>
                    <div class="stat-details">
                        <span class="stat-label">Active in competition</span>
                    </div>
                </div>

            </div>
            </a>
        </div>

        <!-- Actions and Tip Section -->
        <div class="actions-tip-section">
            <div class="tip-card">

                <div class="tip-content">
                    <i class="fas fa-exclamation-circle"></i>
                    Follow up with registered students before deadlines!
                </div>
            </div>
        </div>
    </div>



    <div class="category-charts-container">
        <!-- Category Pie Charts Row -->
    <div class="category-charts-row">
    {% if category_data %}
        {% for category in category_data %}
        <div class="category-chart-card">
            <div class="category-chart-card-title">
                {{ category.name|remove_parentheses }} Category
            </div>

            {% if category.total > 0 %}
                <div class="chart-container">
                    <canvas id="{{ category.name|lower }}PieChart" width="90" height="90"></canvas>
                    <div class="chart-stats">
                        <div><strong>Total Users:</strong> {{ category.total }}</div>
                        <div><strong>Registered:</strong> {{ category.total }}</div>
                        <div><strong>Enrolled:</strong> {{ category.enrolled }}</div>
                    </div>
                </div>
            {% else %}
                <div class="no-data-message">
                    <i class="fas fa-chart-pie"></i>
                    <p>No data available for this category</p>
                    <small>Once users join this category, their stats will appear here</small>
                </div>
            {% endif %}
        </div>
        {% endfor %}
    {% else %}
        <div class="no-data-message">
            <i class="fas fa-chart-pie"></i>
            <p>No category data available yet</p>
            <small>Your referral statistics will appear here once students register</small>
        </div>
    {% endif %}
</div>
<!-- {% if request.user.role == "vendor" %}

<div><h1>Vendor</h1></div>

{% endif %} -->
        <!-- Search and Filter Section -->
       <div class="search-filter-section">
            <div class="search-container">
                <i class="fas fa-search"></i>
                <input type="text" id="searchInput" placeholder="Search by Name or Category">
            </div>
            <div class="filter-dropdown">
                <button class="filter-btn">
                    <i class="fas fa-filter"></i>
                    Filter
                </button>
                <div class="filter-content">
                    <div class="filter-group">
                        <label>Status</label>
                        <select id="statusFilter">
                            <option value="all">All Statuses</option>
                            <option value="enrolled">Enrolled</option>
                            <option value="not-enrolled">Not Enrolled</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Category</label>
                        <select id="categoryFilter">
                            <option value="all">All Categories</option>
                            {% for category in category_data %}
                            <option value="{{ category.name }}">{{ category.name|remove_parentheses }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="filter-buttons">
                        <button id="applyFilters" class="apply-filter-btn">Apply</button>
                        <button id="resetFilters" class="reset-filter-btn">Reset</button>
                    </div>
                </div>
            </div>
        </div>
<div class="table-container">
    <table class="students-table">
        <thead>
            <tr>
                <th><input type="checkbox" id="selectAll"></th>
                <th>Mentor Name</th>
                <th>Email</th>
                <th>Phone</th>
                <th>Registered Date</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody id="mentorsTableBody">
            {% for mentor in mentors %}
            <tr>
                <td><input type="checkbox" class="row-checkbox"></td>
                <td>
                    <div class="student-info">
                     {% if mentor.mentor_profile and mentor.mentor_profile.passport_photo %}
    <img src="{{ mentor.mentor_profile.passport_photo.url }}" 
         alt="{{ mentor.full_name }}" class="student-avatar">
{% else %}
    <img src="https://via.placeholder.com/40" 
         alt="{{ mentor.full_name }}" class="student-avatar">
{% endif %}
                        <div>
                            <div class="student-name">{{ mentor.full_name }}</div>
                            <div class="student-email">{{ mentor.email }}</div>
                        </div>
                    </div>
                </td>
                <td>{{ mentor.email }}</td>
                <td>{{ mentor.phone_number|default:"N/A" }}</td>
                <td>{{ mentor.date_joined|date:"d M, Y" }}</td>
                <td>
                    <a style="text-decoration: none;" href="{% url 'vendor_view_participants' mentor.id %}" 
                       class="action-btn view-btn">
                        <i class="fas fa-eye"></i> View Participants
                    </a>
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="6">No mentors found.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

        <script>
    // Wait for DOM to be fully loaded
    document.addEventListener('DOMContentLoaded', function() {
        // Get the copy button
        const copyButton = document.getElementById('copyReferralBtn');
        
        if (copyButton) {
            copyButton.addEventListener('click', function(e) {
                e.preventDefault();
                
                // Get the referral code text
                const referralCodeElement = document.getElementById('referralCode');
                const referralCode = referralCodeElement ? referralCodeElement.textContent : '';
                
                if (!referralCode) {
                    // Show error if no referral code found
                    Toastify({
                        text: "No referral code found!",
                        duration: 3000,
                        close: true,
                        gravity: "top",
                        position: "right",
                        backgroundColor: "linear-gradient(to right, #ff5f6d, #ffc371)",
                        stopOnFocus: true,
                    }).showToast();
                    return;
                }
                
                // Copy to clipboard
                navigator.clipboard.writeText(referralCode).then(() => {
                    // Show success notification
                    Toastify({
                        text: "Referral code copied to clipboard!",
                        duration: 3000,
                        close: true,
                        gravity: "top",
                        position: "right",
                        backgroundColor: "linear-gradient(to right, #00b09b, #96c93d)",
                        stopOnFocus: true,
                    }).showToast();
                    
                    // Optional: Change button text temporarily to indicate success
                    const originalHtml = copyButton.innerHTML;
                    copyButton.innerHTML = '<i class="bi bi-check-circle me-2"></i>Copied!';
                    
                    setTimeout(() => {
                        copyButton.innerHTML = originalHtml;
                    }, 2000);
                    
                }).catch(err => {
                    // Show error notification if copy fails
                    Toastify({
                        text: "Failed to copy referral code",
                        duration: 3000,
                        close: true,
                        gravity: "top",
                        position: "right",
                        backgroundColor: "linear-gradient(to right, #ff5f6d, #ffc371)",
                        stopOnFocus: true,
                    }).showToast();
                    console.error('Failed to copy text: ', err);
                });
            });
        } else {
            console.error('Copy referral button not found');
        }
    });
</script>

<script src="/static/assets/mentor/js/mentor-dashboard.js"></script>
        <!-- Chart.js CDN -->
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <script>
            // Initialize charts with dynamic data
            const chartOptions = {
                responsive: false,
                plugins: {
                    legend: { display: false }
                }
            };

            {% for category in category_data %}
            new Chart(document.getElementById('{{ category.name|lower }}PieChart'), {
                type: 'pie',
                data: {
                    labels: ['Enrolled', 'Not Enrolled'],
                    datasets: [{
                        data: [{{ category.enrolled }}, {{ category.not_enrolled }}],
                backgroundColor: ['#f95d5d', '#66deb4']
            }]
        },
                options: chartOptions
    });
            {% endfor %}
        </script>


    </div>
</div>


<script>
// Prevent back navigation to login page after authentication
document.addEventListener('DOMContentLoaded', function() {
    // Clear the login page from browser history
    if (window.history && window.history.replaceState) {
        // Replace the current history entry with the dashboard URL
        window.history.replaceState(null, null, window.location.href);
    }
    
    // Intercept any attempts to navigate back to login
    window.addEventListener('popstate', function(event) {
        // Check if we're trying to go back to a login-related page
        if (document.referrer && document.referrer.includes('/auth/login')) {
            // Push the current page again to the history
            window.history.pushState(null, null, window.location.href);
            
            // Show a notification
            showNotification("You're already logged in. Cannot return to login page.");
        }
    });
});

// Function to show notification
function showNotification(message) {
    if (typeof Toastify !== 'undefined') {
        Toastify({
            text: message,
            duration: 3000,
            close: true,
            gravity: "top",
            position: "right",
            backgroundColor: "linear-gradient(to right, #00b09b, #96c93d)",
            stopOnFocus: true,
        }).showToast();
    } else {
        // Fallback to console log if Toastify not available
        console.log(message);
    }
}
</script>
<!-- <script src="/static/assets/mentor/js/dashboard.js"></script> -->
<script src="/static/assets/mentor/js/mentor-dashboard.js"></script>
{% endblock %}