{% extends 'sidebar.html' %}
{% block content %}
<link rel="stylesheet" href="/static/assets/participant/css/profile.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
<script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>

<div class="main-content">
    <div class="container-fluid">
        <div class="profile-card">
            <div class="profile-header">
                <img src="{{ profile.photo.url }}" alt="Profile" class="profile-img">
                <button type="button" class="btn reference_fr border text-white d-flex align-items-center justify-content-center"
                        data-bs-toggle="modal" data-bs-target="#uploadProfileModal">
                    Upload
                </button>
            </div>
            <!-- Modal -->
            <div class="modal fade" id="uploadProfileModal" tabindex="-1" aria-labelledby="uploadProfileModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <form method="POST" enctype="multipart/form-data" action="{% url 'update_profile_photo' %}">
                            {% csrf_token %}
                            <div class="modal-header">
                                <h5 class="modal-title" id="uploadProfileModalLabel">Update Profile Photo</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <div class="form-group">
                                    <label for="photo">Choose New Profile Photo</label>
                                    <input type="file" class="form-control" id="photo" name="photo" accept="image/*" required>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="submit" class="btn-save d-flex align-items-center justify-content-center">Save</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            <hr>

            <form method="POST" enctype="multipart/form-data" id="profileForm">
                {% csrf_token %}
                <!-- First Row - Full Name and Grade -->
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="fullName" class="form-label">Full Name</label>
                        <input type="text" class="form-control" id="fullName" name="full_name" value="{{profile.user.full_name}}">
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="grade" class="form-label">Grade/Class</label>
                        <input type="text" class="form-control" id="grade" name="grade"
                               value="{% if profile.grade %}{{ profile.grade }}{% else %}N/A{% endif %}"
                               placeholder="e.g. 1-10">
                    </div>
                </div>

                <!-- Second Row - Left Column (Fields) and Right Column (Upload) -->
                <div class="row">
                    <!-- Left Column - Date of Birth, Address, School -->
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="dob" class="form-label">Date Of Birth</label>
                            <input type="date" class="form-control" id="dob" name="dob"
                                   value="{% if profile.dob %}{{ profile.dob|date:'Y-m-d' }}{% endif %}">
                        </div>
                        <div class="mb-3">
                            <label for="address" class="form-label">Address</label>
                            <input type="text" class="form-control" id="address" name="address"
                                   value="{{ profile.full_address|default:'' }}">
                        </div>
                        <div class="mb-3">
                            <label for="school" class="form-label">School Name</label>
                            <input type="text" class="form-control" id="school" name="school_name"
                                   value="{{ profile.school_name|default:'' }}">
                        </div>
                    </div>

                    <!-- Right Column - Upload Area -->
                    <div class="col-md-6">
                        <div class="profile-photo-upload">
                            <label class="form-label">Upload education certificates (PDF/JPG)</label>
                            <div class="upload-area" id="eduUploadArea">
                                <span class="upload-icon">
                                    <img src="/static/assets/participant/img/upload_img.png" alt="">
                                </span>
                                <p id="eduFileName" class="upload-text">
                                    <b>Drag & drop a file, or Browse</b><br>
                                    <small>Allowed: PDF, JPG, PNG (Max 5MB)</small>
                                </p>
                                <input type="file" id="eduFileInput" name="edu_doc" class="file-input" accept=".pdf,image/*" style="display:none;">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="d-flex mt-4" style="justify-content:space-between;">
                    <a class="btn-cancel d-flex align-items-center justify-content-center me-2" href="/participants/dashboard/">
                        Cancel
                    </a>
                    <button type="submit" class="btn-save d-flex align-items-center justify-content-center">
                        Save
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
<script>
    const eduUploadArea = document.getElementById('eduUploadArea');
    const eduFileInput = document.getElementById('eduFileInput');
    const eduFileName = document.getElementById('eduFileName');
    const profileForm = document.getElementById('profileForm');

    // Click area opens file dialog
    eduUploadArea.addEventListener('click', () => {
        eduFileInput.click();
    });

    // Show selected file name
    eduFileInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
            eduFileName.innerHTML = `<b>Selected:</b> ${file.name}`;
        }
    });

    // Drag & drop
    eduUploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        eduUploadArea.style.borderColor = '#4e73df';
    });

    eduUploadArea.addEventListener('dragleave', () => {
        eduUploadArea.style.borderColor = '#ddd';
    });

    eduUploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        eduUploadArea.style.borderColor = '#ddd';
        const file = e.dataTransfer.files[0];
        if (file) {
            eduFileInput.files = e.dataTransfer.files;
            eduFileName.innerHTML = `<b>Selected:</b> ${file.name}`;
        }
    });

    // Handle form submission with AJAX
    profileForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        
        fetch(window.location.href, {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                Toastify({
                    text: "Profile updated successfully!",
                    duration: 3000,
                    close: true,
                    gravity: "top",
                    position: "right",
                    backgroundColor: "linear-gradient(to right, #00b09b, #96c93d)",
                    stopOnFocus: true,
                }).showToast();
                
                // Redirect after 3 seconds
                setTimeout(() => {
                    window.location.href = "/participants/dashboard/";
                }, 3000);
            } else {
                Toastify({
                    text: data.error || "Error updating profile",
                    duration: 3000,
                    close: true,
                    gravity: "top",
                    position: "right",
                    backgroundColor: "linear-gradient(to right, #ff5f6d, #ffc371)",
                    stopOnFocus: true,
                }).showToast();
            }
        })
        .catch(error => {
            console.error('Error:', error);
            Toastify({
                text: "An error occurred while updating profile",
                duration: 3000,
                close: true,
                gravity: "top",
                position: "right",
                backgroundColor: "linear-gradient(to right, #ff5f6d, #ffc371)",
                stopOnFocus: true,
            }).showToast();
        });
    });
</script>
{% endblock %}